<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Eclesiástica</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos Gerais */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f6f9; display: flex; height: 100vh; }
        
        /* Menu Lateral */
        .sidebar { width: 250px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; }
        .sidebar h2 { text-align: center; padding: 20px 0; background-color: #1a252f; margin: 0; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background-color: #34495e; border-left: 5px solid #3498db; }
        .menu-item i { margin-right: 10px; width: 20px; }
        
        /* Conteúdo Principal */
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; } /* Esconde todas as seções */
        .section.active { display: block; } /* Mostra só a ativa */

        /* Dashboard Cards */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin: 0; font-size: 14px; color: #7f8c8d; }
        .card .valor { font-size: 24px; font-weight: bold; margin-top: 10px; color: #2c3e50; }
        .card.verde { border-bottom: 4px solid #27ae60; }
        .card.vermelho { border-bottom: 4px solid #c0392b; }
        .card.azul { border-bottom: 4px solid #2980b9; }

        /* Tabelas */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; color: #555; }
        
        /* Status Badges */
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .badge-ok { background-color: #d4edda; color: #155724; } /* Verde */
        .badge-falha { background-color: #f8d7da; color: #721c24; } /* Vermelho */

        /* Formulários */
        .form-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .form-group { display: flex; flex-direction: column; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background-color: #27ae60; }
        .btn-del { background-color: #c0392b; padding: 5px 10px; font-size: 12px; }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>IGREJA SYS</h2>
        <div class="menu-item active" onclick="mostrarTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
        <div class="menu-item" onclick="mostrarTab('membros')"><i class="fas fa-users"></i> Membros</div>
        <div class="menu-item" onclick="mostrarTab('financeiro')"><i class="fas fa-wallet"></i> Financeiro</div>
        <div class="menu-item" style="margin-top: auto; background: #c0392b;" onclick="sair()"><i class="fas fa-sign-out-alt"></i> Sair</div>
    </div>

    <div class="content">

        <div id="dashboard" class="section active">
            <h1>Visão Geral</h1>
            <div class="dash-grid">
                <div class="card azul"><h3>Total em Caixa</h3><div class="valor" id="dash-saldo">R$ 0,00</div></div>
                <div class="card verde"><h3>Entradas (Mês)</h3><div class="valor" id="dash-entradas">R$ 0,00</div></div>
                <div class="card vermelho"><h3>Saídas (Mês)</h3><div class="valor" id="dash-saidas">R$ 0,00</div></div>
                <div class="card"><h3>Dizimistas Fiéis</h3><div class="valor" id="dash-fieis">0</div></div>
                <div class="card vermelho"><h3>Em Falha (+35 dias)</h3><div class="valor" id="dash-falha" style="color: red;">0</div></div>
            </div>
            
            <h3>Últimas Movimentações</h3>
            <div id="lista-dashboard"></div>
        </div>

        <div id="membros" class="section">
            <h1>Gestão de Membros</h1>
            
            <div class="form-box">
                <div class="form-group"><label>Nome do Membro</label><input type="text" id="novo-nome" placeholder="Ex: João Silva"></div>
                <div class="form-group"><label>Telefone</label><input type="text" id="novo-tel" placeholder="(00) 00000-0000"></div>
                <button class="btn btn-add" onclick="addMembro()">Cadastrar Membro</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Status Dízimo</th>
                        <th>Última Contribuição</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabela-membros">
                    </tbody>
            </table>
        </div>

        <div id="financeiro" class="section">
            <h1>Livro Caixa</h1>

            <div class="form-box" style="background-color: #e8f6f3;">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="fin-tipo">
                        <option value="entrada">ENTRADA (+)</option>
                        <option value="saida">SAÍDA (-)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="fin-cat">
                        <option value="Dizimo">Dízimo</option>
                        <option value="Oferta">Oferta (Anônima)</option>
                        <option value="Cantina">Venda Cantina</option>
                        <option value="Conta Luz">Conta de Luz</option>
                        <option value="Agua">Água</option>
                        <option value="Manutencao">Manutenção/Pedreiro</option>
                        <option value="Ajuda">Ajuda de Custo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="fin-valor" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Membro (Opcional)</label>
                    <select id="fin-membro">
                        <option value="">-- Selecione se for Dízimo --</option>
                        </select>
                </div>
                <button class="btn btn-add" onclick="lancarFinanceiro()">Registrar</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody id="tabela-financeiro">
                    </tbody>
            </table>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- COLE SUA CONFIGURAÇÃO DO FIREBASE AQUI NOVAMENTE ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "NUMERO"
        };
        // --------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Verifica login
        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "index.html"; }
            else { carregarDados(); }
        });

        // Variáveis globais para guardar dados
        let listaMembros = [];
        let listaFinancas = [];

        // --- FUNÇÕES DE NAVEGAÇÃO ---
        window.mostrarTab = function(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        window.sair = function() {
            signOut(auth).then(() => window.location.href = "index.html");
        }

        // --- CARREGAR DADOS DO FIREBASE (TEMPO REAL) ---
        function carregarDados() {
            // 1. Ouvir Membros
            const qMembros = query(collection(db, "membros"), orderBy("nome"));
            onSnapshot(qMembros, (snapshot) => {
                listaMembros = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderizarMembros();
                atualizarSelectMembros();
                atualizarDashboard();
            });

            // 2. Ouvir Financeiro
            const qFinancas = query(collection(db, "financeiro"), orderBy("data", "desc"));
            onSnapshot(qFinancas, (snapshot) => {
                listaFinancas = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderizarFinanceiro();
                atualizarDashboard();
            });
        }

        // --- LÓGICA DE MEMBROS ---
        window.addMembro = async function() {
            const nome = document.getElementById('novo-nome').value;
            const tel = document.getElementById('novo-tel').value;
            if(!nome) return alert("Preencha o nome!");

            // Cria o membro com uma data antiga para ele começar como "Novo"
            await addDoc(collection(db, "membros"), {
                nome: nome,
                telefone: tel,
                ultima_contribuicao: "2000-01-01" // Data antiga padrão
            });
            
            document.getElementById('novo-nome').value = "";
            document.getElementById('novo-tel').value = "";
            alert("Membro cadastrado!");
        }

        function renderizarMembros() {
            const tbody = document.getElementById('tabela-membros');
            tbody.innerHTML = "";

            listaMembros.forEach(m => {
                // Cálculo de dias desde o último dízimo
                const hoje = new Date();
                const ultimaData = new Date(m.ultima_contribuicao);
                const diffTempo = Math.abs(hoje - ultimaData);
                const diasPassados = Math.ceil(diffTempo / (1000 * 60 * 60 * 24));
                
                let statusHtml = "";
                let corClasse = "";

                // Regra: Se passou de 35 dias, é inadimplente
                if (m.ultima_contribuicao === "2000-01-01") {
                    statusHtml = "Novo / Nunca Dizimou";
                    corClasse = "badge-falha";
                } else if (diasPassados > 35) {
                    statusHtml = `Em Falha (${diasPassados} dias)`;
                    corClasse = "badge-falha";
                } else {
                    statusHtml = "Fiel (Em dia)";
                    corClasse = "badge-ok";
                }

                const dataFormatada = m.ultima_contribuicao === "2000-01-01" ? "--" : ultimaData.toLocaleDateString('pt-BR');

                tbody.innerHTML += `
                    <tr>
                        <td>${m.nome}<br><small style="color:#888">${m.telefone}</small></td>
                        <td><span class="badge ${corClasse}">${statusHtml}</span></td>
                        <td>${dataFormatada}</td>
                        <td><button class="btn btn-del" onclick="deletarMembro('${m.id}')">Excluir</button></td>
                    </tr>
                `;
            });
        }

        window.deletarMembro = async function(id) {
            if(confirm("Tem certeza que deseja excluir este membro?")) {
                await deleteDoc(doc(db, "membros", id));
            }
        }

        function atualizarSelectMembros() {
            const select = document.getElementById('fin-membro');
            select.innerHTML = '<option value="">-- Selecione se for Dízimo --</option>';
            listaMembros.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
            });
        }

        // --- LÓGICA FINANCEIRA ---
        window.lancarFinanceiro = async function() {
            const tipo = document.getElementById('fin-tipo').value;
            const categoria = document.getElementById('fin-cat').value;
            const valor = parseFloat(document.getElementById('fin-valor').value);
            const membroId = document.getElementById('fin-membro').value;

            if(!valor) return alert("Digite um valor!");

            const hoje = new Date().toISOString().split('T')[0]; // Data YYYY-MM-DD

            // 1. Salva no histórico financeiro
            await addDoc(collection(db, "financeiro"), {
                tipo: tipo,
                categoria: categoria,
                valor: valor,
                data: hoje,
                membro_id: membroId, // Pode ser vazio se for oferta anônima
                data_registro: new Date().toISOString()
            });

            // 2. Se foi Dízimo e tem membro selecionado, atualiza a data do membro
            if (tipo === "entrada" && membroId) {
                const membroRef = doc(db, "membros", membroId);
                await updateDoc(membroRef, {
                    ultima_contribuicao: hoje
                });
            }

            // Limpa form
            document.getElementById('fin-valor').value = "";
            alert("Lançamento Registrado!");
        }

        function renderizarFinanceiro() {
            const tbody = document.getElementById('tabela-financeiro');
            tbody.innerHTML = "";

            listaFinancas.forEach(f => {
                const cor = f.tipo === 'entrada' ? 'green' : 'red';
                const sinal = f.tipo === 'entrada' ? '+' : '-';
                
                // Tenta achar o nome do membro se tiver ID
                let nomeMembro = "";
                if(f.membro_id) {
                    const membro = listaMembros.find(m => m.id === f.membro_id);
                    if(membro) nomeMembro = `(${membro.nome})`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(f.data).toLocaleDateString('pt-BR')}</td>
                        <td><span style="color:${cor}; font-weight:bold">${f.tipo.toUpperCase()}</span></td>
                        <td>${f.categoria} ${nomeMembro}</td>
                        <td style="color:${cor}">${sinal} R$ ${f.valor.toFixed(2)}</td>
                    </tr>
                `;
            });
        }

        // --- LÓGICA DASHBOARD ---
        function atualizarDashboard() {
            let totalEntrada = 0;
            let totalSaida = 0;
            let fieis = 0;
            let falha = 0;

            // Calcula Finanças
            listaFinancas.forEach(f => {
                if(f.tipo === 'entrada') totalEntrada += f.valor;
                else totalSaida += f.valor;
            });

            // Calcula Membros
            listaMembros.forEach(m => {
                const hoje = new Date();
                const ultimaData = new Date(m.ultima_contribuicao);
                const diff = Math.ceil(Math.abs(hoje - ultimaData) / (1000 * 60 * 60 * 24));
                
                if(m.ultima_contribuicao !== "2000-01-01" && diff <= 35) fieis++;
                else falha++;
            });

            document.getElementById('dash-entradas').innerText = `R$ ${totalEntrada.toFixed(2)}`;
            document.getElementById('dash-saidas').innerText = `R$ ${totalSaida.toFixed(2)}`;
            document.getElementById('dash-saldo').innerText = `R$ ${(totalEntrada - totalSaida).toFixed(2)}`;
            document.getElementById('dash-fieis').innerText = fieis;
            document.getElementById('dash-falha').innerText = falha;
        }

    </script>
</body>
</html>
